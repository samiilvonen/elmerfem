!----------------------------------------------------------------------------
! This is a test case for testing out FilmFlowSolver for 2D channel flow.
!
! Based on the primary case difference there is a Neumann boundary
! condition on BC4.
!
! This case also has a turbulent flow friction. To speed up convergence of nonlinear
! system a minimum value of Reynolds number is given. This also tunes the speed used
! in the linearization of the drag.
!
! P.R. 7.4.25
!-----------------------------------------------------------------------------
$ h0 = 0.5
$ nu = 1.0e-3
$ dh = 0.1
$ rho = 1.0e3
$ h1 = h0+dh
$appnd="False"

Header
  CHECK KEYWORDS Warn
  Mesh DB "." "rect"
  Include Path ""
  Results Directory "results"
End

Simulation
  Max Output Level = 7
  Coordinate System = Cartesian 2D
  Simulation Type = Steady State
  Steady State Max Iterations = 1

  Output Intervals = 0
  Post File = film.vtu
  vtu: ascii output = true
End


Body 1
  Target Bodies(1) = 1
  Name = "Body 1"
  Equation = 1
  Material = 1
End

Solver 1
  Equation = "FilmFlow"

! For 1D models the only velocity component is called "Speed"
  Model Dimension = Integer 2
  Procedure = "FilmFlowSolver" "FilmFlowSolver"

  Nonlinear System Convergence Tolerance = 1.0e-6
  Nonlinear System Max Iterations = 30
  Nonlinear System Newton After Iterations = 30
  Nonlinear System Relaxation Factor = 0.5
  Nonlinear System Newton After Tolerance = 0.0e-3

  Linear System Solver = Direct
  Linear System Direct Method = umfpack

  Friction Model = String "darcy"

  Convect = True
  Min Reynolds Number = Real 4000.0

!  Calculate Loads = True
End


Solver 2
  Equation = "SaveMaterial"
  Procedure = File "SaveData" "SaveMaterials"
  Parameter 1 = String "Gap Height"
End


Solver 3
  Equation = "SaveScalars"
  Procedure = "SaveData" "SaveScalars"

  Operator 1 = range
  Variable 1 = FilmPressure
  Operator 2 = boundary max
  Variable 2 = FilmVelocity 1

  Expression 1 = Real $h0
  Expression 2 = Real $dh
  
  Filename = "film.dat"
  File Append = Logical $appnd$

  Show Norm Index = 1
End

Equation 1 :: Active Solvers = 1

Material 1
  Density = $rho
  Viscosity = $nu
  Gap Height = Variable "Coordinate 1"
    Real
      0.0 $h0
      5.0 $h1
    End
  Darcy Roughness = Real 0.01
End

Boundary Condition 1
  Target Boundaries(1) = 1
  Name = "Bot"
  FilmVelocity 2 = 0.0
End

Boundary Condition 2
  Target Boundaries(1) = 2
  Name = "Right"
  FilmVelocity 2 = 0.0
  Save Scalars = True
  FilmPressure = 0.0
End

Boundary Condition 3
  Target Boundaries(1) = 3
  Name = "Top"
  FilmVelocity 2 = 0.0
End

Boundary Condition 4
  Target Boundaries(1) = 4
  Name = "Left"
!  FilmVelocity 1 = $v0
! This was tuned so that the upper condition is reproduced
  Pressure 1 = 1.0e3
End


Solver 1 :: Reference Norm = 3.59384612E-01
Solver 3 :: Reference Norm = 9.99023284E+02

